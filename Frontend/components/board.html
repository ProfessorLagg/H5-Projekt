<template id="tmpl-game-board">
    <style>
        :host {
            --cell-empty-opacity: 36%;
            --cell-color-dark: rgba(0, 0, 0, var(--cell-empty-opacity));
            --cell-color-light: rgba(255, 255, 255, var(--cell-empty-opacity));
            --cell-border-color: rgba(153, 145, 102, 100%);
            --cell-space: calc(min(0.25vh, 0.5vw)/2 + 0.49px);
            --cell-highlight: 0 0 calc(var(--baseunit) * 1.25) 0 rgba(255, 255, 255, 100%) inset;
        }

        :host {
            aspect-ratio: 1/1;
            display: grid;
            grid-auto-flow: row dense;
            grid-auto-columns: 1fr;
            grid-auto-rows: 1fr;
            grid-template-columns: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            grid-template-rows: 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr 1fr;
            gap: 0px 0px;
            grid-template-areas:
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . ."
                ". . . . . . . . .";
            background-color: rgba(100, 45, 0, 100%);
            background-blend-mode: multiply;
            border: var(--cell-space) solid var(--cell-border-color);
        }

        .board-cell {
            display: block;
            aspect-ratio: 1/1;
            text-align: center;
            justify-content: center;
            border: var(--cell-space) solid var(--cell-border-color);
            border-radius: 10%;
            background-color: magenta;
            background-blend-mode: multiply;
        }

        /* Even Groups */
        .board-cell[grp="0"],
        .board-cell[grp="2"],
        .board-cell[grp="4"],
        .board-cell[grp="6"],
        .board-cell[grp="8"] {
            background-color: var(--cell-color-dark);
            box-shadow: 0 0 8px 0 black inset;
        }

        /* Uneven Groups */
        .board-cell[grp="1"],
        .board-cell[grp="3"],
        .board-cell[grp="5"],
        .board-cell[grp="7"] {
            background-color: var(--cell-color-light);
            box-shadow: 0 0 8px 0 black inset;
        }

        /* Cell State*/
        .board-cell:hover {
            box-shadow: var(--cell-highlight) !important;
        }

        .board-cell[state="0"] {
            background-image: url(/img/pixel-dots.svg);
            background-clip: border-box;
        }

        .board-cell[state="1"] {
            background-image: url(/img/block_white.svg);
            background-color: hsla(30, 100%, 24%, 50%);
            background-size: cover;
            background-blend-mode: multiply;
            box-shadow: none;
        }
    </style>
</template>
<script id="scrpt-game-board">
    function indexTo1D(row, col) {
        const r = Math.max(0, Math.min(9, row));
        const c = Math.max(0, Math.min(9, col));
        return r * 9 + c;
    }
    function indexTo2D(index) {
        const idx = Math.max(0, Math.min(80, index));
        const col = idx % 9;
        const row = (idx - col) / 9
        return {
            row: row,
            col: col,
        }
    }
    function calcGroup(row, col) {
        const r = Math.max(0, Math.min(9, row));
        const c = Math.max(0, Math.min(9, col));
        const gr = Math.floor(r / 3) * 3;
        const gc = Math.floor(c / 3);
        return gr + gc;
    }

    const boardElementName = 'game-board';
    const boardTemplateId = 'tmpl-game-board';
    const boardTemplate = document.getElementById(boardTemplateId);
    class CustomBoardElement extends HTMLElement {
        cellClickHandler(e) {
            console.debug("board cell click handler:", e.target);
            let state = parseInt(e.target.getAttribute("state"));
            let idx = parseInt(e.target.getAttribute("idx"));
            if (state === 0) {
                e.target.setAttribute("state", 1);
            } else if (state === 1) {
                e.target.setAttribute("state", 0);
            } else {
                console.error("Invalid cell state:", state, "on element: ", e.target);
            }
        }
        createCells() {
            console.debug(this.localName, "createCells()");
            for (let row = 0; row < 9; row += 1) {
                for (let col = 0; col < 9; col++) {
                    let elem = document.createElement("div");
                    let idx = indexTo1D(row, col);
                    let grp = calcGroup(row, col);
                    elem.setAttribute("idx", idx)
                    elem.setAttribute("grp", grp)
                    elem.setAttribute("row", row);
                    elem.setAttribute("col", col);
                    elem.setAttribute("state", 0);
                    elem.classList.add("board-cell");

                    elem.addEventListener("click", e => {
                        this.cellClickHandler(e);
                    });
                    this.shadowRoot.appendChild(elem);
                }
            }
        }
        connectedCallback() {
            console.debug(this.localName, "connectedCallback()");
            let templateContent = boardTemplate.content;

            let shadowRoot = this.attachShadow({ mode: "open" });
            shadowRoot.appendChild(templateContent.cloneNode(true));
            this.createCells();

        }
        constructor() {
            super();
            console.debug(this.localName, "constructor()");
        }
    }

    customElements.define(boardElementName, CustomBoardElement);
</script>